<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcShot æ»šåŠ¨æˆªå›¾é—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-item {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .status-ok { border-left-color: #28a745; background: #f8fff9; }
        .status-warning { border-left-color: #ffc107; background: #fffdf5; }
        .status-error { border-left-color: #dc3545; background: #fff8f8; }
        .fix-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 0 0;
        }
        .fix-button:hover { background: #0056b3; }
        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ”§ ArcShot æ»šåŠ¨æˆªå›¾é—®é¢˜è¯Šæ–­å·¥å…·</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li>ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®æ£€æŸ¥å½“å‰çŠ¶æ€</li>
                <li>æŸ¥çœ‹è¯Šæ–­ç»“æœï¼Œçº¢è‰²è¡¨ç¤ºéœ€è¦ä¿®å¤çš„é—®é¢˜</li>
                <li>æŒ‰ç…§å»ºè®®çš„ä¿®å¤æ­¥éª¤æ“ä½œ</li>
                <li>ä¿®å¤å®Œæˆåé‡æ–°æµ‹è¯•æ‰‹åŠ¨+æ»šåŠ¨æˆªå›¾åŠŸèƒ½</li>
            </ol>
        </div>

        <button id="diagnoseBtn" class="fix-button">ğŸ” å¼€å§‹è¯Šæ–­</button>
        <button id="clearStorageBtn" class="fix-button">ğŸ§¹ æ¸…é™¤å­˜å‚¨æ•°æ®</button>
        
        <div id="diagnosisResults"></div>

        <div class="info-box">
            <h3>ğŸ¯ ä¿®å¤åæµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>æ‰“å¼€ä»»æ„ç½‘é¡µï¼ˆå†…å®¹è¦è¶³å¤Ÿé•¿éœ€è¦æ»šåŠ¨ï¼‰</li>
                <li>ç‚¹å‡» ArcShot æ‰©å±•å›¾æ ‡</li>
                <li><strong>å‹¾é€‰</strong>"æ™ºèƒ½æ»šåŠ¨æˆªå›¾"é€‰é¡¹</li>
                <li>ç‚¹å‡»"æ‰‹åŠ¨é€‰æ‹©åŒºåŸŸ"æŒ‰é’®</li>
                <li>é€‰æ‹©ä¸€ä¸ªåŒºåŸŸï¼ˆç¡®ä¿åŒºåŸŸè¶³å¤Ÿå¤§éœ€è¦æ»šåŠ¨ï¼‰</li>
                <li>ç­‰å¾…æˆªå›¾å®Œæˆï¼Œç»“æœé¡µåº”è¯¥æ˜¾ç¤ºæ‹¼æ¥åçš„é•¿å›¾</li>
            </ol>
        </div>

        <div class="info-box">
            <h3>âš ï¸ å¸¸è§é—®é¢˜å¤„ç†</h3>
            <ul>
                <li><strong>æƒé™é—®é¢˜</strong>ï¼šé‡æ–°åŠ è½½æ‰©å±•æˆ–é‡å¯æµè§ˆå™¨</li>
                <li><strong>æ ‡ç­¾é¡µé—®é¢˜</strong>ï¼šç¡®ä¿åŸå§‹é¡µé¢æœªå…³é—­</li>
                <li><strong>è¶…æ—¶é—®é¢˜</strong>ï¼šé€‰æ‹©è¾ƒå°çš„åŒºåŸŸæˆ–ç½‘ç»œè¾ƒå¥½çš„é¡µé¢</li>
                <li><strong>æ•°æ®æ®‹ç•™</strong>ï¼šä½¿ç”¨"æ¸…é™¤å­˜å‚¨æ•°æ®"æŒ‰é’®</li>
            </ul>
        </div>
    </div>

    <script>
        const diagnoseBtn = document.getElementById('diagnoseBtn');
        const clearStorageBtn = document.getElementById('clearStorageBtn');
        const diagnosisResults = document.getElementById('diagnosisResults');

        // è¯Šæ–­ç³»ç»ŸçŠ¶æ€
        async function diagnoseSystem() {
            diagnosisResults.innerHTML = '<h2>ğŸ” è¯Šæ–­è¿›è¡Œä¸­...</h2>';
            
            const results = [];
            
            // 1. æ£€æŸ¥æ‰©å±•æƒé™
            try {
                const hasPermissions = await new Promise((resolve) => {
                    chrome.permissions.contains({
                        permissions: ['tabs', 'storage'],
                        origins: ['<all_urls>']
                    }, resolve);
                });
                
                if (hasPermissions) {
                    results.push({
                        type: 'ok',
                        title: 'âœ… æ‰©å±•æƒé™',
                        message: 'æ‰€æœ‰å¿…éœ€æƒé™å·²æˆæƒ'
                    });
                } else {
                    results.push({
                        type: 'error',
                        title: 'âŒ æ‰©å±•æƒé™ä¸è¶³',
                        message: 'ç¼ºå°‘å¿…è¦æƒé™ï¼Œè¯·é‡æ–°åŠ è½½æ‰©å±•',
                        fix: 'é‡æ–°åŠ è½½ArcShotæ‰©å±•'
                    });
                }
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ æƒé™æ£€æŸ¥å¤±è´¥',
                    message: error.message
                });
            }

            // 2. æ£€æŸ¥å­˜å‚¨æ•°æ®
            try {
                const storageData = await new Promise((resolve) => {
                    chrome.storage.local.get(null, resolve);
                });
                
                const keys = Object.keys(storageData);
                if (keys.length === 0) {
                    results.push({
                        type: 'ok',
                        title: 'âœ… å­˜å‚¨çŠ¶æ€',
                        message: 'å­˜å‚¨æ•°æ®å¹²å‡€ï¼Œæ— æ®‹ç•™æ•°æ®'
                    });
                } else {
                    results.push({
                        type: 'warning',
                        title: 'âš ï¸ å­˜å‚¨æ•°æ®',
                        message: `å‘ç°${keys.length}é¡¹å­˜å‚¨æ•°æ®: ${keys.slice(0, 3).join(', ')}${keys.length > 3 ? '...' : ''}`,
                        fix: 'å»ºè®®æ¸…é™¤å­˜å‚¨æ•°æ®åé‡æ–°æµ‹è¯•'
                    });
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ»šåŠ¨æˆªå›¾ç›¸å…³æ•°æ®
                const scrollingKeys = keys.filter(key => 
                    key.includes('scrolling') || 
                    key.includes('stitch') || 
                    key.includes('metadata')
                );
                
                if (scrollingKeys.length > 0) {
                    results.push({
                        type: 'warning',
                        title: 'âš ï¸ æ»šåŠ¨æˆªå›¾æ®‹ç•™æ•°æ®',
                        message: `å‘ç°æ»šåŠ¨æˆªå›¾ç›¸å…³æ•°æ®: ${scrollingKeys.join(', ')}`,
                        fix: 'è¿™äº›æ•°æ®å¯èƒ½å¯¼è‡´é—®é¢˜ï¼Œå»ºè®®æ¸…é™¤'
                    });
                }
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ å­˜å‚¨æ£€æŸ¥å¤±è´¥',
                    message: error.message
                });
            }

            // 3. æ£€æŸ¥å½“å‰æ ‡ç­¾é¡µçŠ¶æ€
            try {
                const tabs = await new Promise((resolve) => {
                    chrome.tabs.query({ currentWindow: true }, resolve);
                });
                
                const currentTab = tabs.find(tab => tab.active);
                const nonExtensionTabs = tabs.filter(tab => 
                    !tab.url.startsWith('chrome-extension://') && 
                    !tab.url.startsWith('chrome://')
                );
                
                if (nonExtensionTabs.length > 0) {
                    results.push({
                        type: 'ok',
                        title: 'âœ… æ ‡ç­¾é¡µçŠ¶æ€',
                        message: `æ‰¾åˆ°${nonExtensionTabs.length}ä¸ªå¯æˆªå›¾çš„æ ‡ç­¾é¡µ`
                    });
                } else {
                    results.push({
                        type: 'warning',
                        title: 'âš ï¸ æ ‡ç­¾é¡µçŠ¶æ€',
                        message: 'æ²¡æœ‰æ‰¾åˆ°å¯æˆªå›¾çš„æ™®é€šç½‘é¡µæ ‡ç­¾é¡µ',
                        fix: 'è¯·æ‰“å¼€ä¸€ä¸ªæ™®é€šç½‘é¡µè¿›è¡Œæµ‹è¯•'
                    });
                }
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ æ ‡ç­¾é¡µæ£€æŸ¥å¤±è´¥',
                    message: error.message
                });
            }

            // æ˜¾ç¤ºç»“æœ
            displayResults(results);
        }

        // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
        function displayResults(results) {
            let html = '<h2>ğŸ” è¯Šæ–­ç»“æœ</h2>';
            
            results.forEach(result => {
                html += `
                    <div class="status-item status-${result.type}">
                        <h3>${result.title}</h3>
                        <p>${result.message}</p>
                        ${result.fix ? `<p><strong>å»ºè®®ä¿®å¤ï¼š</strong>${result.fix}</p>` : ''}
                    </div>
                `;
            });

            // æ·»åŠ ä¿®å¤å»ºè®®
            const hasErrors = results.some(r => r.type === 'error');
            const hasWarnings = results.some(r => r.type === 'warning');
            
            if (hasErrors) {
                html += `
                    <div class="status-item status-error">
                        <h3>ğŸš¨ å‘ç°ä¸¥é‡é—®é¢˜</h3>
                        <p>è¯·å…ˆè§£å†³ä¸Šè¿°é”™è¯¯é—®é¢˜ï¼Œç„¶åé‡æ–°è¯Šæ–­ã€‚</p>
                    </div>
                `;
            } else if (hasWarnings) {
                html += `
                    <div class="status-item status-warning">
                        <h3>âš ï¸ å‘ç°æ½œåœ¨é—®é¢˜</h3>
                        <p>å»ºè®®å¤„ç†ä¸Šè¿°è­¦å‘Šé—®é¢˜ï¼Œç„¶åè¿›è¡Œæµ‹è¯•ã€‚</p>
                    </div>
                `;
            } else {
                html += `
                    <div class="status-item status-ok">
                        <h3>âœ… ç³»ç»ŸçŠ¶æ€è‰¯å¥½</h3>
                        <p>å¯ä»¥å¼€å§‹æµ‹è¯•æ‰‹åŠ¨+æ»šåŠ¨æˆªå›¾åŠŸèƒ½ã€‚</p>
                    </div>
                `;
            }
            
            diagnosisResults.innerHTML = html;
        }

        // æ¸…é™¤å­˜å‚¨æ•°æ®
        function clearStorage() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ArcShotå­˜å‚¨æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æˆªå›¾ç¼“å­˜ã€‚')) {
                return;
            }
            
            chrome.storage.local.clear(() => {
                if (chrome.runtime.lastError) {
                    alert('æ¸…é™¤å¤±è´¥: ' + chrome.runtime.lastError.message);
                } else {
                    alert('âœ… å­˜å‚¨æ•°æ®å·²æ¸…é™¤ï¼å»ºè®®é‡æ–°è¿›è¡Œè¯Šæ–­ã€‚');
                    diagnosisResults.innerHTML = '<p>å­˜å‚¨æ•°æ®å·²æ¸…é™¤ï¼Œè¯·é‡æ–°è¯Šæ–­ã€‚</p>';
                }
            });
        }

        // äº‹ä»¶ç›‘å¬å™¨
        diagnoseBtn.addEventListener('click', diagnoseSystem);
        clearStorageBtn.addEventListener('click', clearStorage);

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿›è¡Œä¸€æ¬¡è¯Šæ–­
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ”§ ArcShot è¯Šæ–­å·¥å…·å·²åŠ è½½');
        });
    </script>
</body>
</html>