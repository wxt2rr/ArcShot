<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcShot æ‰‹åŠ¨æ»šåŠ¨æˆªå›¾è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-item {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .status-ok { border-left-color: #28a745; background: #f8fff9; }
        .status-warning { border-left-color: #ffc107; background: #fffdf5; }
        .status-error { border-left-color: #dc3545; background: #fff8f8; }
        .status-info { border-left-color: #17a2b8; background: #f8fcff; }
        .action-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 0 0;
        }
        .action-button:hover { background: #0056b3; }
        .danger-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 0 0;
        }
        .danger-button:hover { background: #c82333; }
        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .log-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .step-guide {
            counter-reset: step-counter;
        }
        .step-guide li {
            counter-increment: step-counter;
            margin: 10px 0;
            padding-left: 10px;
        }
        .step-guide li::before {
            content: "æ­¥éª¤ " counter(step-counter) ": ";
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ”§ ArcShot æ‰‹åŠ¨æ»šåŠ¨æˆªå›¾è°ƒè¯•å·¥å…·</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <p>è¿™ä¸ªå·¥å…·ä¸“é—¨ç”¨äºè¯Šæ–­æ‰‹åŠ¨+æ»šåŠ¨æˆªå›¾åŠŸèƒ½çš„é—®é¢˜ï¼Œå¸®åŠ©æ‚¨æ‰¾åˆ°å¹¶è§£å†³"æ²¡æœ‰æˆåŠŸæˆªå–ä»»ä½•å›¾ç‰‡"çš„é”™è¯¯ã€‚</p>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="diagnoseBtn" class="action-button">ğŸ” å¼€å§‹å…¨é¢è¯Šæ–­</button>
            <button id="clearStorageBtn" class="danger-button">ğŸ§¹ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button id="testScrollingBtn" class="action-button">ğŸ§ª æµ‹è¯•æ»šåŠ¨æˆªå›¾</button>
        </div>
        
        <div id="diagnosisResults"></div>
        <div id="testResults"></div>

        <div class="info-box">
            <h3>ğŸ¯ æ ‡å‡†æµ‹è¯•æµç¨‹</h3>
            <ol class="step-guide">
                <li>ç¡®ä¿å½“å‰çª—å£æœ‰é™¤æ­¤è¯Šæ–­é¡µé¢å¤–çš„å…¶ä»–æ™®é€šç½‘é¡µ</li>
                <li>ç‚¹å‡»"å¼€å§‹å…¨é¢è¯Šæ–­"æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</li>
                <li>å¦‚å‘ç°é—®é¢˜ï¼ŒæŒ‰æç¤ºä¿®å¤åé‡æ–°è¯Šæ–­</li>
                <li>ç‚¹å‡»"æµ‹è¯•æ»šåŠ¨æˆªå›¾"è¿›è¡ŒåŠŸèƒ½æµ‹è¯•</li>
                <li>å¦‚æœæµ‹è¯•å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—</li>
                <li>ä¿®å¤å®Œæˆåï¼Œæµ‹è¯•çœŸå®çš„æ‰‹åŠ¨+æ»šåŠ¨æˆªå›¾åŠŸèƒ½</li>
            </ol>
        </div>

        <div class="info-box">
            <h3>âš ï¸ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ</h3>
            <ul>
                <li><strong>"æ²¡æœ‰æˆåŠŸæˆªå–ä»»ä½•å›¾ç‰‡"</strong>ï¼šé€šå¸¸æ˜¯æƒé™æˆ–æ ‡ç­¾é¡µé—®é¢˜</li>
                <li><strong>"MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND"</strong>ï¼šæˆªå›¾é¢‘ç‡è¿‡é«˜ï¼Œå¢åŠ å»¶è¿Ÿ</li>
                <li><strong>"not in effect"</strong>ï¼šæ ‡ç­¾é¡µçŠ¶æ€å¼‚å¸¸ï¼Œåˆ‡æ¢åˆ°æ­£ç¡®æ ‡ç­¾é¡µ</li>
                <li><strong>"permission denied"</strong>ï¼šæ‰©å±•æƒé™ä¸è¶³ï¼Œé‡æ–°åŠ è½½æ‰©å±•</li>
            </ul>
        </div>

        <div id="debugLogs" class="log-container" style="display: none;">
            <h4>ğŸ” è°ƒè¯•æ—¥å¿—ï¼š</h4>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        const diagnoseBtn = document.getElementById('diagnoseBtn');
        const clearStorageBtn = document.getElementById('clearStorageBtn');
        const testScrollingBtn = document.getElementById('testScrollingBtn');
        const diagnosisResults = document.getElementById('diagnosisResults');
        const testResults = document.getElementById('testResults');
        const debugLogs = document.getElementById('debugLogs');
        const logContent = document.getElementById('logContent');

        // æ—¥å¿—è®°å½•å‡½æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.style.color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#333';
            logItem.textContent = `[${timestamp}] ${message}`;
            logContent.appendChild(logItem);
            logContent.scrollTop = logContent.scrollHeight;
            debugLogs.style.display = 'block';
        }

        // å…¨é¢è¯Šæ–­ç³»ç»ŸçŠ¶æ€
        async function comprehensiveDiagnosis() {
            diagnosisResults.innerHTML = '<h2>ğŸ” æ­£åœ¨è¿›è¡Œå…¨é¢è¯Šæ–­...</h2>';
            addLog('å¼€å§‹å…¨é¢è¯Šæ–­');
            
            const results = [];
            
            // 1. æ£€æŸ¥æ‰©å±•æƒé™
            try {
                addLog('æ£€æŸ¥æ‰©å±•æƒé™...');
                const hasPermissions = await new Promise((resolve) => {
                    chrome.permissions.contains({
                        permissions: ['tabs', 'storage'],
                        origins: ['<all_urls>']
                    }, resolve);
                });
                
                if (hasPermissions) {
                    results.push({
                        type: 'ok',
                        title: 'âœ… æ‰©å±•æƒé™æ­£å¸¸',
                        message: 'æ‰€æœ‰å¿…éœ€æƒé™å·²æˆæƒ'
                    });
                    addLog('æ‰©å±•æƒé™æ£€æŸ¥é€šè¿‡', 'info');
                } else {
                    results.push({
                        type: 'error',
                        title: 'âŒ æ‰©å±•æƒé™ä¸è¶³',
                        message: 'ç¼ºå°‘å¿…è¦æƒé™ï¼Œè¿™æ˜¯å¯¼è‡´æˆªå›¾å¤±è´¥çš„ä¸»è¦åŸå› ',
                        fix: 'è¯·åœ¨æ‰©å±•ç®¡ç†é¡µé¢é‡æ–°åŠ è½½ArcShotæ‰©å±•'
                    });
                    addLog('æ‰©å±•æƒé™ä¸è¶³', 'error');
                }
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ æƒé™æ£€æŸ¥å¤±è´¥',
                    message: error.message
                });
                addLog(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }

            // 2. æ£€æŸ¥å­˜å‚¨æ•°æ®çŠ¶æ€
            try {
                addLog('æ£€æŸ¥å­˜å‚¨æ•°æ®...');
                const storageData = await new Promise((resolve) => {
                    chrome.storage.local.get(null, resolve);
                });
                
                const keys = Object.keys(storageData);
                const manualKeys = keys.filter(key => key.includes('manual_'));
                const scrollingKeys = keys.filter(key => 
                    key.includes('scrolling') || 
                    key.includes('stitch') || 
                    key.includes('metadata')
                );
                
                if (manualKeys.length > 0 || scrollingKeys.length > 0) {
                    results.push({
                        type: 'warning',
                        title: 'âš ï¸ å‘ç°æ®‹ç•™æ•°æ®',
                        message: `æ‰‹åŠ¨æˆªå›¾æ•°æ®: ${manualKeys.length}é¡¹ï¼Œæ»šåŠ¨æ•°æ®: ${scrollingKeys.length}é¡¹`,
                        fix: 'å»ºè®®æ¸…é™¤è¿™äº›æ•°æ®ä»¥é¿å…å¹²æ‰°'
                    });
                    addLog(`å‘ç°æ®‹ç•™æ•°æ®: manual=${manualKeys.length}, scrolling=${scrollingKeys.length}`, 'warning');
                } else {
                    results.push({
                        type: 'ok',
                        title: 'âœ… å­˜å‚¨çŠ¶æ€å¹²å‡€',
                        message: 'æ— æ®‹ç•™æ•°æ®'
                    });
                    addLog('å­˜å‚¨çŠ¶æ€æ£€æŸ¥é€šè¿‡', 'info');
                }
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ å­˜å‚¨æ£€æŸ¥å¤±è´¥',
                    message: error.message
                });
                addLog(`å­˜å‚¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }

            // 3. æ£€æŸ¥å¯ç”¨æ ‡ç­¾é¡µ
            try {
                addLog('æ£€æŸ¥å¯ç”¨æ ‡ç­¾é¡µ...');
                const tabs = await new Promise((resolve) => {
                    chrome.tabs.query({ currentWindow: true }, resolve);
                });
                
                const currentTab = tabs.find(tab => tab.active);
                const validTabs = tabs.filter(tab => 
                    !tab.url.startsWith('chrome-extension://') && 
                    !tab.url.startsWith('chrome://') &&
                    tab.url !== 'about:blank' &&
                    !tab.url.includes('debug_manual_scrolling.html')
                );
                
                if (validTabs.length > 0) {
                    results.push({
                        type: 'ok',
                        title: 'âœ… æ ‡ç­¾é¡µçŠ¶æ€è‰¯å¥½',
                        message: `æ‰¾åˆ°${validTabs.length}ä¸ªå¯ç”¨äºæˆªå›¾çš„æ ‡ç­¾é¡µ`
                    });
                    addLog(`æ‰¾åˆ°${validTabs.length}ä¸ªå¯ç”¨æ ‡ç­¾é¡µ`, 'info');
                    
                    // æ˜¾ç¤ºå¯ç”¨æ ‡ç­¾é¡µä¿¡æ¯
                    const tabInfo = validTabs.map(tab => `${tab.title.substring(0, 30)}... (ID: ${tab.id})`).join('\n');
                    results.push({
                        type: 'info',
                        title: 'ğŸ“‹ å¯ç”¨æ ‡ç­¾é¡µåˆ—è¡¨',
                        message: tabInfo
                    });
                } else {
                    results.push({
                        type: 'error',
                        title: 'âŒ æ²¡æœ‰å¯ç”¨æ ‡ç­¾é¡µ',
                        message: 'æ²¡æœ‰æ‰¾åˆ°å¯æˆªå›¾çš„æ™®é€šç½‘é¡µï¼Œè¿™æ˜¯å¯¼è‡´æˆªå›¾å¤±è´¥çš„ä¸»è¦åŸå› ',
                        fix: 'è¯·æ‰“å¼€ä¸€ä¸ªæ™®é€šç½‘é¡µï¼ˆå¦‚ç™¾åº¦ã€æ–°æµªç­‰ï¼‰è¿›è¡Œæµ‹è¯•'
                    });
                    addLog('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨æ ‡ç­¾é¡µ', 'error');
                }
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ æ ‡ç­¾é¡µæ£€æŸ¥å¤±è´¥',
                    message: error.message
                });
                addLog(`æ ‡ç­¾é¡µæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }

            // 4. æµ‹è¯•åŸºç¡€æˆªå›¾åŠŸèƒ½
            try {
                addLog('æµ‹è¯•åŸºç¡€æˆªå›¾åŠŸèƒ½...');
                await new Promise((resolve, reject) => {
                    chrome.tabs.captureVisibleTab(null, { format: 'png' }, (dataUrl) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(dataUrl);
                        }
                    });
                });
                
                results.push({
                    type: 'ok',
                    title: 'âœ… åŸºç¡€æˆªå›¾åŠŸèƒ½æ­£å¸¸',
                    message: 'å¯ä»¥æ­£å¸¸è°ƒç”¨captureVisibleTab API'
                });
                addLog('åŸºç¡€æˆªå›¾åŠŸèƒ½æµ‹è¯•é€šè¿‡', 'info');
            } catch (error) {
                results.push({
                    type: 'error',
                    title: 'âŒ åŸºç¡€æˆªå›¾åŠŸèƒ½å¼‚å¸¸',
                    message: `æ— æ³•è¿›è¡ŒåŸºç¡€æˆªå›¾: ${error.message}`,
                    fix: 'è¿™æ˜¯æ ¸å¿ƒé—®é¢˜ï¼Œè¯·æ£€æŸ¥æ‰©å±•æƒé™å’Œæ ‡ç­¾é¡µçŠ¶æ€'
                });
                addLog(`åŸºç¡€æˆªå›¾åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }

            // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            displayDiagnosisResults(results);
            addLog('å…¨é¢è¯Šæ–­å®Œæˆ');
        }

        // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
        function displayDiagnosisResults(results) {
            let html = '<h2>ğŸ” è¯Šæ–­ç»“æœ</h2>';
            
            results.forEach(result => {
                html += `
                    <div class="status-item status-${result.type}">
                        <h3>${result.title}</h3>
                        <p>${result.message}</p>
                        ${result.fix ? `<p><strong>ä¿®å¤å»ºè®®ï¼š</strong>${result.fix}</p>` : ''}
                    </div>
                `;
            });

            const hasErrors = results.some(r => r.type === 'error');
            const hasWarnings = results.some(r => r.type === 'warning');
            
            if (hasErrors) {
                html += `
                    <div class="status-item status-error">
                        <h3>ğŸš¨ å‘ç°å…³é”®é—®é¢˜</h3>
                        <p>è¯·å…ˆè§£å†³ä¸Šè¿°é”™è¯¯é—®é¢˜ï¼Œç„¶åé‡æ–°è¯Šæ–­ã€‚è¿™äº›é—®é¢˜æ˜¯å¯¼è‡´"æ²¡æœ‰æˆåŠŸæˆªå–ä»»ä½•å›¾ç‰‡"é”™è¯¯çš„æ ¹æœ¬åŸå› ã€‚</p>
                    </div>
                `;
            } else if (hasWarnings) {
                html += `
                    <div class="status-item status-warning">
                        <h3>âš ï¸ å»ºè®®å¤„ç†è­¦å‘Š</h3>
                        <p>ç³»ç»ŸåŸºæœ¬æ­£å¸¸ï¼Œä½†å»ºè®®å¤„ç†è­¦å‘Šé—®é¢˜ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚</p>
                    </div>
                `;
            } else {
                html += `
                    <div class="status-item status-ok">
                        <h3>âœ… ç³»ç»ŸçŠ¶æ€ä¼˜ç§€</h3>
                        <p>æ‰€æœ‰æ£€æŸ¥å‡é€šè¿‡ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰‹åŠ¨+æ»šåŠ¨æˆªå›¾åŠŸèƒ½ã€‚</p>
                    </div>
                `;
            }
            
            diagnosisResults.innerHTML = html;
        }

        // æµ‹è¯•æ»šåŠ¨æˆªå›¾åŠŸèƒ½
        async function testScrollingScreenshot() {
            testResults.innerHTML = '<h2>ğŸ§ª æ­£åœ¨æµ‹è¯•æ»šåŠ¨æˆªå›¾...</h2>';
            addLog('å¼€å§‹æµ‹è¯•æ»šåŠ¨æˆªå›¾åŠŸèƒ½');
            
            try {
                // è·å–å¯ç”¨æ ‡ç­¾é¡µ
                const tabs = await new Promise((resolve) => {
                    chrome.tabs.query({ currentWindow: true }, resolve);
                });
                
                const testTab = tabs.find(tab => 
                    !tab.url.startsWith('chrome-extension://') && 
                    !tab.url.startsWith('chrome://') &&
                    !tab.url.includes('debug_manual_scrolling.html')
                );
                
                if (!testTab) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨äºæµ‹è¯•çš„æ ‡ç­¾é¡µ');
                }
                
                addLog(`ä½¿ç”¨æ ‡ç­¾é¡µè¿›è¡Œæµ‹è¯•: ${testTab.title} (ID: ${testTab.id})`);
                
                // æ¨¡æ‹Ÿæ‰‹åŠ¨+æ»šåŠ¨æˆªå›¾çš„è°ƒç”¨
                addLog('å‘é€æ¶ˆæ¯åˆ°background.jsè¿›è¡Œæµ‹è¯•...');
                
                const testSelection = {
                    x: 0,
                    y: 0,
                    width: 800,
                    height: 600
                };
                
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        action: 'areaSelection',
                        selection: testSelection,
                        enableSmartScrolling: true
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                addLog(`æ”¶åˆ°å“åº”: ${JSON.stringify(response)}`);
                
                if (response && response.success) {
                    testResults.innerHTML = `
                        <div class="status-item status-ok">
                            <h3>âœ… æµ‹è¯•æˆåŠŸ</h3>
                            <p>æ»šåŠ¨æˆªå›¾åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼</p>
                            <p>å“åº”æ•°æ®: ${JSON.stringify(response, null, 2)}</p>
                        </div>
                    `;
                    addLog('æ»šåŠ¨æˆªå›¾æµ‹è¯•æˆåŠŸ', 'info');
                } else {
                    throw new Error(response?.error || 'æµ‹è¯•è¿”å›å¼‚å¸¸ç»“æœ');
                }
                
            } catch (error) {
                testResults.innerHTML = `
                    <div class="status-item status-error">
                        <h3>âŒ æµ‹è¯•å¤±è´¥</h3>
                        <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <p>è¿™ä¸ªé”™è¯¯åæ˜ äº†å®é™…ä½¿ç”¨ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚</p>
                    </div>
                `;
                addLog(`æ»šåŠ¨æˆªå›¾æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®
        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ArcShotå­˜å‚¨æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æˆªå›¾ç¼“å­˜å’Œé…ç½®ã€‚')) {
                return;
            }
            
            addLog('å¼€å§‹æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®...');
            chrome.storage.local.clear(() => {
                if (chrome.runtime.lastError) {
                    const error = 'æ¸…é™¤å¤±è´¥: ' + chrome.runtime.lastError.message;
                    alert(error);
                    addLog(error, 'error');
                } else {
                    const success = 'âœ… æ‰€æœ‰å­˜å‚¨æ•°æ®å·²æ¸…é™¤ï¼å»ºè®®é‡æ–°è¿›è¡Œè¯Šæ–­ã€‚';
                    alert(success);
                    addLog(success, 'info');
                    diagnosisResults.innerHTML = '<p style="text-align: center; color: #28a745; font-weight: bold;">å­˜å‚¨æ•°æ®å·²æ¸…é™¤ï¼Œè¯·é‡æ–°è¿›è¡Œè¯Šæ–­ã€‚</p>';
                    testResults.innerHTML = '';
                }
            });
        }

        // äº‹ä»¶ç›‘å¬å™¨
        diagnoseBtn.addEventListener('click', comprehensiveDiagnosis);
        clearStorageBtn.addEventListener('click', clearAllData);
        testScrollingBtn.addEventListener('click', testScrollingScreenshot);

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºè¯´æ˜
        document.addEventListener('DOMContentLoaded', () => {
            addLog('ArcShot æ‰‹åŠ¨æ»šåŠ¨æˆªå›¾è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            console.log('ğŸ”§ ArcShot æ‰‹åŠ¨æ»šåŠ¨æˆªå›¾è°ƒè¯•å·¥å…·å·²å¯åŠ¨');
        });
    </script>
</body>
</html>